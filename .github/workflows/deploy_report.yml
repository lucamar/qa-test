# Run tests, generate a timestamped pytest-html report, upload as artifact,
# and (ONLY WHEN TESTS PASS) commit/update files under reports/ on master branch.
#
# Trigger: push to main and manual dispatch
on:
  push:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-tests-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository (fetch all history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-html pytest-playwright
          # install Playwright browsers
          python -m playwright install

      - name: Run tests and generate pytest-html report (always produce report file)
        id: run_tests
        # Allow the step to continue so we can decide later whether to push to master
        continue-on-error: true
        run: |
          set -e
          mkdir -p reports reports/history

          # Run pytest and capture exit code so we can decide what to push later.
          pytest -q --html=reports/report.html --self-contained-html || true
          PYTEST_EXIT_CODE=$?
          echo "PYTEST_EXIT_CODE=$PYTEST_EXIT_CODE" >> $GITHUB_ENV

          # Ensure a report file exists (if pytest failed to produce one, create a placeholder)
          if [ ! -f reports/report.html ]; then
            # Use printf to avoid heredoc YAML quoting issues
            printf '%s\n' '<!doctype html>' '<html>' '<head>' '<meta charset="utf-8">' '<title>No report</title>' '</head>' '<body>' '<h1>No pytest-html report was generated</h1>' '</body>' '</html>' > reports/report.html
          fi

          # Create a stable timestamp and export it for later steps
          TIMESTAMP=$(date -u +%Y%m%dT%H%M%SZ)
          echo "REPORT_TIMESTAMP=$TIMESTAMP" >> $GITHUB_ENV

          # Copy report.html into index.html (optional convenience) and create a history entry
          cp -f reports/report.html reports/index.html
          cp -f reports/report.html "reports/history/report-${TIMESTAMP}.html"

          echo "Generated files:"
          ls -la reports || true

      - name: Upload report files as workflow artifact
        uses: actions/upload-artifact@v4
        with:
          name: pytest-html-report-${{ env.REPORT_TIMESTAMP }}
          path: |
            reports/report.html
            reports/index.html
            reports/history/report-${{ env.REPORT_TIMESTAMP }}.html

      - name: Commit & push reports/ to master (only if tests passed)
        if: env.PYTEST_EXIT_CODE == '0'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -e
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Ensure we have a reference to origin/master (if it exists)
          git fetch origin master || true

          # Create or check out local master tracking origin/master if available, otherwise create master
          if git ls-remote --exit-code --heads origin master >/dev/null 2>&1; then
            # checkout local master (create if needed) and reset to origin/master to avoid surprises
            if git rev-parse --verify master >/dev/null 2>&1; then
              git checkout master
              git reset --mixed origin/master
            else
              git checkout -b master origin/master
            fi
          else
            # origin/master does not exist: create local master branch from current HEAD
            git checkout -b master
          fi

          # Ensure remote uses token auth for push
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"

          # Stage only the reports directory so other files are untouched
          git add -A reports

          # Commit only if there are staged changes
          if git diff --cached --quiet; then
            echo "No changes in reports/ to commit."
          else
            git commit -m "Publish pytest-html report: ${{ github.sha }} (timestamp: ${{ env.REPORT_TIMESTAMP }})"
            git push origin master
            echo "Pushed reports/ to master."
          fi

      - name: Show debug info
        run: |
          echo "PYTEST_EXIT_CODE=${{ env.PYTEST_EXIT_CODE }}"
          echo "REPORT_TIMESTAMP=${{ env.REPORT_TIMESTAMP }}"
          echo "If tests passed and a push happened, the report will be at:"
          echo "https://lucamar.github.io/qa-test/reports/report.html"
          echo "or (timestamped) https://lucamar.github.io/qa-test/reports/history/report-${{ env.REPORT_TIMESTAMP }}.html"
